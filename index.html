<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê°™ì´ ì‹œì¼œìš” ğŸ±</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#FAF7F2;--card:#FFF;--accent:#E85D26;--accent-soft:#FFF0EB;--dark:#1A1A1A;--mid:#6B6B6B;--light:#E8E4DF;--green:#2D8F5E;--green-soft:#EAFAF1;--yellow:#F5A623;--yellow-soft:#FFF8EC;--red:#D94545;--red-soft:#FFF0F0;--blue:#3B82F6;--blue-soft:#EFF6FF;--purple:#8B5CF6;--purple-soft:#F3EEFF}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--dark);min-height:100vh;-webkit-font-smoothing:antialiased}
input:focus,textarea:focus,select:focus{outline:2px solid var(--accent);outline-offset:-2px}
button{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--light);border-radius:4px}
@keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{to{transform:rotate(360deg)}}

.notification{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:1000;padding:12px 24px;border-radius:12px;color:#fff;font-weight:700;font-size:14px;box-shadow:0 8px 32px rgba(0,0,0,.15);animation:slideDown .3s ease;pointer-events:none;max-width:90vw;text-align:center}
.container{max-width:480px;margin:0 auto;padding:0 20px}
.setup-banner{background:linear-gradient(135deg,#FFFBE6,#FFF0EB);border:2px dashed var(--yellow);border-radius:16px;padding:20px;margin-bottom:24px;text-align:center;animation:fadeUp .5s ease}
.setup-banner h3{font-size:15px;margin-bottom:8px}.setup-banner p{font-size:13px;color:var(--mid);line-height:1.6}
.setup-banner code{display:inline-block;background:var(--card);padding:4px 12px;border-radius:8px;font-size:12px;font-weight:700;margin-top:8px;word-break:break-all;border:1px solid var(--light)}
.home-hero{text-align:center;margin-bottom:40px;animation:fadeUp .6s ease}
.home-hero .emoji{font-size:64px;margin-bottom:8px;animation:float 3s ease-in-out infinite}
.home-hero h1{font-size:32px;font-weight:900;letter-spacing:-1px;margin-bottom:8px}
.home-hero p{color:var(--mid);font-size:15px;line-height:1.6}
.input-label{font-size:12px;font-weight:700;color:var(--mid);display:block;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.input-field{width:100%;padding:14px 18px;border-radius:14px;border:2px solid var(--light);font-size:16px;background:var(--card);font-family:inherit;transition:border .2s}
.input-field:hover{border-color:#ccc}
.home-card{background:var(--card);border-radius:20px;padding:28px;box-shadow:0 2px 16px rgba(0,0,0,.04);margin-bottom:16px}
.home-card h2{font-size:18px;font-weight:800;margin-bottom:16px}
.btn-primary{width:100%;padding:16px;border-radius:14px;border:none;background:var(--accent);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s;font-family:inherit}
.btn-primary:hover{transform:scale(1.02);box-shadow:0 6px 20px rgba(232,93,38,.3)}.btn-primary:active{transform:scale(.98)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.btn-dark{width:100%;padding:16px;border-radius:14px;border:2px solid var(--dark);background:var(--dark);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:transform .15s;font-family:inherit}
.btn-dark:hover{transform:scale(1.02)}
.code-input{width:100%;padding:14px 18px;border-radius:14px;border:2px solid var(--light);font-size:22px;font-weight:800;letter-spacing:6px;text-align:center;background:var(--bg);text-transform:uppercase;font-family:inherit}
.room-header{position:sticky;top:0;z-index:100;background:rgba(250,247,242,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--light)}
.room-header-inner{max-width:600px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
.back-btn{background:none;border:none;font-size:22px;cursor:pointer;padding:4px}
.room-code{font-size:22px;font-weight:900;letter-spacing:4px;cursor:pointer;color:var(--accent)}.room-code:hover{text-decoration:underline}
.status-badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700}
.status-open{background:var(--green-soft);color:var(--green)}.status-locked{background:var(--red-soft);color:var(--red)}
.tab-bar{display:flex;gap:4px;background:var(--card);border-radius:14px;padding:4px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.tab-btn{flex:1;padding:12px 8px;border-radius:10px;border:none;background:transparent;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;color:var(--mid)}
.tab-btn.active{background:var(--accent);color:#fff}
.stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px}
.stat-card{border-radius:14px;padding:14px 12px;text-align:center}.stat-card .value{font-size:22px;font-weight:900}.stat-card .label{font-size:11px;color:var(--mid);font-weight:600;margin-top:2px}
.cat-pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.cat-pill{padding:8px 16px;border-radius:20px;border:2px solid var(--light);background:var(--card);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.cat-pill:hover{border-color:#ccc}.cat-pill.active{border-color:var(--accent);background:var(--accent-soft)}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;animation:fadeUp .3s ease}
.menu-btn{padding:12px 8px;border-radius:12px;border:1.5px solid var(--light);background:var(--card);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit}
.menu-btn:hover{border-color:var(--accent);background:var(--accent-soft)}
.custom-row{display:flex;gap:8px}
.custom-input{flex:1;padding:12px 16px;border-radius:12px;border:2px solid var(--light);font-size:15px;background:var(--bg);font-family:inherit}
.qty-control{display:flex;align-items:center;gap:2px;background:var(--bg);border-radius:12px;padding:0 6px;border:2px solid var(--light)}
.qty-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 8px;font-weight:700}
.qty-val{font-size:16px;font-weight:800;min-width:20px;text-align:center}
.add-btn{padding:12px 20px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-size:15px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:inherit}
.user-card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
.user-card.is-me{border:2px solid rgba(232,93,38,.12)}
.user-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.avatar{width:32px;height:32px;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}
.me-tag{font-size:10px;background:var(--accent-soft);color:var(--accent);padding:2px 8px;border-radius:10px;font-weight:700}
.order-row{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-bottom:4px;background:var(--bg);border-radius:10px;font-size:14px;flex-wrap:wrap}
.order-menu{font-weight:600;flex:1;min-width:60px}
.order-qty{font-size:12px;background:var(--yellow-soft);color:var(--yellow);padding:2px 8px;border-radius:8px;font-weight:700}
.order-note{font-size:11px;color:var(--mid);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.order-time{font-size:11px;color:var(--mid)}
.icon-btn{background:none;border:none;cursor:pointer;font-size:14px;padding:2px}
.note-row{padding:8px 12px;display:flex;gap:8px}
.note-input{flex:1;padding:8px 12px;border-radius:8px;border:1.5px solid var(--light);font-size:13px;font-family:inherit}
.note-save{padding:8px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit}
.summary-card{background:var(--card);border-radius:16px;padding:20px;margin-bottom:24px;box-shadow:0 2px 12px rgba(0,0,0,.03)}
.summary-inner{background:var(--bg);border-radius:12px;padding:16px;font-size:14px;line-height:1.8}
.summary-row{display:flex;justify-content:space-between;border-bottom:1px dashed var(--light);padding-bottom:4px;margin-bottom:4px}
.summary-total{margin-top:10px;padding-top:10px;border-top:2px solid var(--dark);display:flex;justify-content:space-between;font-weight:900;font-size:16px}
.btn-outline{width:100%;margin-top:12px;padding:12px;border-radius:12px;border:2px solid var(--dark);background:transparent;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
.bottom-controls{display:flex;gap:10px;margin-bottom:8px}
.btn-lock{flex:1;padding:14px;border-radius:14px;border:none;color:#fff;font-size:15px;font-weight:700;cursor:pointer;transition:transform .15s;font-family:inherit}.btn-lock:hover{transform:scale(1.02)}
.btn-share{padding:14px 20px;border-radius:14px;border:2px solid var(--light);background:var(--card);font-size:15px;font-weight:700;cursor:pointer;font-family:inherit}
.sync-info{text-align:center;margin-top:12px;font-size:11px;color:var(--mid)}
.sync-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:4px;animation:pulse 2s infinite}
.empty-state{text-align:center;padding:40px;color:var(--mid);background:var(--card);border-radius:16px}
.empty-state .emoji{font-size:48px;margin-bottom:12px}
.section-title{font-size:15px;font-weight:700;margin-bottom:12px}
.room-body{max-width:600px;margin:0 auto;padding:16px 20px 120px}
.hidden{display:none!important}

/* Upload & Receipt */
.upload-zone{border:2px dashed var(--light);border-radius:16px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--card);position:relative;overflow:hidden}
.upload-zone:hover{border-color:var(--accent);background:var(--accent-soft)}
.upload-zone.dragging{border-color:var(--accent);background:var(--accent-soft);transform:scale(1.01)}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:40px;margin-bottom:8px}.upload-text{font-size:14px;font-weight:600;color:var(--mid)}.upload-hint{font-size:12px;color:var(--light);margin-top:4px}
.receipt-preview{width:100%;max-height:300px;object-fit:contain;border-radius:12px;margin-bottom:16px;border:1px solid var(--light)}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid var(--light);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
.analyzing-box{background:var(--accent-soft);border-radius:14px;padding:24px;text-align:center;margin-bottom:20px}
.analyzing-box p{font-size:14px;font-weight:600;color:var(--accent);margin-top:10px}
.settle-user-card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
.settle-user-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.settle-user-name{font-weight:800;font-size:16px;display:flex;align-items:center;gap:8px}
.settle-user-total{font-weight:900;font-size:18px;color:var(--accent)}
.settle-item-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px dashed var(--light)}.settle-item-row:last-child{border-bottom:none}
.settle-grand-total{background:var(--dark);color:#fff;border-radius:14px;padding:20px;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.settle-grand-total .label{font-size:15px;font-weight:700}.settle-grand-total .amount{font-size:24px;font-weight:900}
.settle-edit-row{display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px dashed var(--light)}.settle-edit-row:last-child{border-bottom:none}
.api-key-section{background:var(--blue-soft);border:2px solid var(--blue);border-radius:14px;padding:16px;margin-bottom:20px}
.api-key-section label{font-size:13px;font-weight:700;color:var(--blue);display:block;margin-bottom:8px}
.api-key-input{width:100%;padding:10px 14px;border-radius:10px;border:1.5px solid var(--light);font-size:13px;font-family:monospace}
.api-key-hint{font-size:11px;color:var(--mid);margin-top:6px;line-height:1.5}
.api-key-row{display:flex;gap:8px}.api-key-row input{flex:1}
.key-status{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:10px;font-size:13px;font-weight:600;margin-bottom:12px}
.key-status.connected{background:var(--green-soft);color:var(--green)}.key-status.disconnected{background:var(--red-soft);color:var(--red)}

/* Menu scan */
.menu-scan-section{background:var(--purple-soft);border:2px solid var(--purple);border-radius:16px;padding:20px;margin-bottom:24px}
.menu-scan-section h3{color:var(--purple);font-size:15px;font-weight:700;margin-bottom:12px}
.multi-upload-zone{border:2px dashed rgba(139,92,246,.3);border-radius:14px;padding:24px 16px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(139,92,246,.05);position:relative;overflow:hidden}
.multi-upload-zone:hover{border-color:var(--purple);background:rgba(139,92,246,.1)}
.multi-upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.preview-strip{display:flex;gap:8px;overflow-x:auto;padding:8px 0;margin-top:12px}
.preview-thumb{position:relative;flex-shrink:0}
.preview-thumb img{width:80px;height:80px;object-fit:cover;border-radius:10px;border:2px solid var(--light)}
.preview-thumb .remove-thumb{position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
.scanned-menu-grid{display:grid;grid-template-columns:1fr;gap:6px;margin-top:12px;max-height:400px;overflow-y:auto}
.scanned-menu-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--card);border-radius:12px;border:1.5px solid var(--light);cursor:pointer;transition:all .15s}
.scanned-menu-item:hover{border-color:var(--purple);background:var(--purple-soft)}
.scanned-menu-item .menu-name{font-weight:600;font-size:14px;flex:1}
.scanned-menu-item .menu-price{font-weight:700;font-size:14px;color:var(--accent);white-space:nowrap}
.scanned-menu-item .menu-add-btn{padding:6px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:inherit}
.scan-count{font-size:12px;color:var(--mid);margin-top:4px}
</style>
</head>
<body>
<div id="notification" class="notification hidden"></div>

<!-- HOME -->
<div id="screen-home">
<div class="container" style="padding-top:60px;padding-bottom:40px">
<div class="home-hero"><div class="emoji">ğŸ±</div><h1>ê°™ì´ ì‹œì¼œìš”</h1><p>í•¨ê»˜ ì ì‹¬ ì£¼ë¬¸í•˜ê³ , ë©”ë‰´ ëˆ„ë½ ì—†ì´ ê¹”ë”í•˜ê²Œ!<br>ë°°ë‹¬ì•± ìº¡ì²˜ë¡œ ë©”ë‰´ ìë™ ì¸ì‹ Â· ì˜ìˆ˜ì¦ ìë™ ì •ì‚°</p></div>
<div style="animation:fadeUp .6s ease .1s both"><label class="input-label">ë‚´ ì´ë¦„</label><input id="nameInput" class="input-field" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:24px"></div>
<div class="home-card" style="animation:fadeUp .6s ease .2s both"><h2>ğŸ†• ìƒˆ ë°© ë§Œë“¤ê¸°</h2><button class="btn-primary" onclick="createRoom()">ë°© ë§Œë“¤ê¸°</button></div>
<div class="home-card" style="animation:fadeUp .6s ease .3s both"><h2>ğŸ”— ë°© ì°¸ì—¬í•˜ê¸°</h2><input id="joinInput" class="code-input" placeholder="ë°© ì½”ë“œ 6ìë¦¬" maxlength="6" oninput="this.value=this.value.toUpperCase()" style="margin-bottom:14px"><button class="btn-dark" onclick="joinRoom()">ì°¸ì—¬í•˜ê¸°</button></div>
</div></div>

<!-- ROOM -->
<div id="screen-room" class="hidden">
<div class="room-header"><div class="room-header-inner">
<button class="back-btn" onclick="goHome()">â†</button>
<div style="text-align:center"><div style="font-size:13px;color:var(--mid);font-weight:600">ë°© ì½”ë“œ</div><div class="room-code" id="roomCodeDisplay" onclick="copyRoomCode()"></div></div>
<div id="statusBadge" class="status-badge status-open">ğŸŸ¢ ì£¼ë¬¸ì¤‘</div>
</div></div>

<div class="room-body">
<div id="setupBanner" class="setup-banner"><h3>âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h3><p>ì•„ë˜ <strong>firebaseConfig</strong>ì— ë³¸ì¸ì˜ Firebase ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”.</p><code>const firebaseConfig = { apiKey: "...", ... }</code></div>

<div class="tab-bar">
<button class="tab-btn active" id="tabOrder" onclick="switchTab('order')">ğŸ½ï¸ ì£¼ë¬¸</button>
<button class="tab-btn" id="tabSettle" onclick="switchTab('settle')">ğŸ§¾ ì •ì‚°</button>
</div>

<!-- ORDER TAB -->
<div id="orderTab">
<div class="stats-grid">
<div class="stat-card" style="background:var(--accent-soft)"><div class="value" style="color:var(--accent)" id="statUsers">0ëª…</div><div class="label">ì°¸ì—¬ì</div></div>
<div class="stat-card" style="background:var(--green-soft)"><div class="value" style="color:var(--green)" id="statTotal">0ê°œ</div><div class="label">ì´ ë©”ë‰´</div></div>
<div class="stat-card" style="background:var(--yellow-soft)"><div class="value" style="color:var(--yellow)" id="statKinds">0ê°€ì§€</div><div class="label">ì¢…ë¥˜</div></div>
</div>

<!-- MENU SCAN SECTION -->
<div id="menuScanSection" class="menu-scan-section">
<h3>ğŸ“¸ ë°°ë‹¬ì•± ë©”ë‰´ ìŠ¤ìº”</h3>
<p style="font-size:13px;color:var(--mid);margin-bottom:12px">ì¿ íŒ¡ì´ì¸ , ë°°ë¯¼, ìš”ê¸°ìš” ë“± ë°°ë‹¬ì•± ë©”ë‰´ í™”ë©´ì„ ìº¡ì²˜í•´ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.<br>ì—¬ëŸ¬ ì¥ë„ OK!</p>

<div id="menuUploadZone" class="multi-upload-zone"
  ondragover="event.preventDefault();this.classList.add('dragging')"
  ondragleave="this.classList.remove('dragging')"
  ondrop="event.preventDefault();this.classList.remove('dragging');handleMenuDrop(event)">
  <input type="file" accept="image/*" multiple onchange="handleMenuFiles(event)">
  <div style="font-size:32px;margin-bottom:6px">ğŸ“±</div>
  <div style="font-size:14px;font-weight:600;color:var(--purple)">ë©”ë‰´ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ</div>
  <div style="font-size:12px;color:var(--mid);margin-top:4px">ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥ Â· ìµœëŒ€ 10ì¥</div>
</div>

<div id="menuPreviewStrip" class="preview-strip hidden"></div>

<div id="menuScanActions" class="hidden" style="margin-top:12px;display:flex;gap:8px">
  <button class="btn-primary" style="background:var(--purple)" onclick="scanMenuImages()">ğŸ” ë©”ë‰´ ì¸ì‹í•˜ê¸°</button>
  <button class="btn-outline" style="width:auto;padding:12px 18px;margin-top:0;border-color:var(--light)" onclick="clearMenuImages()">ì´ˆê¸°í™”</button>
</div>

<div id="menuAnalyzingBox" class="analyzing-box hidden" style="background:var(--purple-soft)">
  <div class="spinner" style="border-top-color:var(--purple)"></div>
  <p style="color:var(--purple)">Claudeê°€ ë©”ë‰´ë¥¼ ì¸ì‹í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
</div>

<div id="scannedMenuList" class="hidden" style="margin-top:16px">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <h3 class="section-title" style="margin-bottom:0">ğŸ½ï¸ ì¸ì‹ëœ ë©”ë‰´</h3>
    <span id="scannedMenuCount" class="scan-count"></span>
  </div>
  <div id="scannedMenuGrid" class="scanned-menu-grid"></div>
</div>
</div>

<!-- Quick Category Menu -->
<div id="quickMenuSection">
<h3 class="section-title">âš¡ ë¹ ë¥¸ ë©”ë‰´ ì„ íƒ</h3>
<div class="cat-pills" id="catPills"></div>
<div class="menu-grid hidden" id="menuGrid"></div>
<div style="margin-bottom:24px"></div>
</div>

<!-- Custom Order -->
<div id="customOrderSection" style="margin-bottom:24px">
<div class="home-card" style="margin-bottom:0">
<h3 class="section-title">âœï¸ ì§ì ‘ ì…ë ¥</h3>
<div class="custom-row">
<input id="customItemInput" class="custom-input" placeholder="ë©”ë‰´ ì´ë¦„" onkeydown="if(event.key==='Enter')addCustomOrder()">
<div class="qty-control"><button class="qty-btn" onclick="changeQty(-1)">âˆ’</button><span class="qty-val" id="qtyDisplay">1</span><button class="qty-btn" onclick="changeQty(1)">+</button></div>
<button class="add-btn" onclick="addCustomOrder()">ì¶”ê°€</button>
</div></div></div>

<div><h3 class="section-title">ğŸ“‹ ì£¼ë¬¸ í˜„í™©</h3><div id="ordersContainer"></div></div>

<div id="summarySection" class="hidden">
<div class="summary-card"><h3 class="section-title">ğŸ“Š ì£¼ë¬¸ ìš”ì•½</h3><div class="summary-inner" id="summaryInner"></div><button class="btn-outline" onclick="copySummary()">ğŸ“‹ ì£¼ë¬¸ ìš”ì•½ ë³µì‚¬</button></div>
</div>

<div class="bottom-controls">
<button id="lockBtn" class="btn-lock" style="background:var(--red)" onclick="toggleLock()">ğŸ”’ ì£¼ë¬¸ ë§ˆê°</button>
<button class="btn-share" onclick="shareRoom()">ğŸ”— ê³µìœ </button>
</div>
<div class="sync-info" id="syncInfo"></div>
</div>

<!-- SETTLE TAB -->
<div id="settleTab" class="hidden">
<div class="api-key-section" id="apiKeySection">
<div id="keyStatusBar"></div>
<label>ğŸ”‘ Anthropic API Key</label>
<div class="api-key-row"><input id="apiKeyInput" class="api-key-input" type="password" placeholder="sk-ant-...">
<button onclick="saveApiKeyToRoom()" style="padding:10px 18px;border-radius:10px;border:none;background:var(--blue);color:#fff;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;font-family:inherit">ì €ì¥</button></div>
<div class="api-key-hint">ë°©ì¥ì´ í•œ ë²ˆ ì €ì¥í•˜ë©´ ê°™ì€ ë°© ì‚¬ëŒ ëª¨ë‘ ì •ì‚° ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>í‚¤ëŠ” ì•”í˜¸í™”ë˜ì–´ Firebaseì— ì €ì¥ë˜ë©°, ì´ ë°©ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
</div>

<div id="uploadZone" class="upload-zone"
  ondragover="event.preventDefault();this.classList.add('dragging')"
  ondragleave="this.classList.remove('dragging')"
  ondrop="event.preventDefault();this.classList.remove('dragging');handleFileDrop(event)">
  <input type="file" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
  <div class="upload-icon">ğŸ§¾</div>
  <div class="upload-text">ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”</div>
  <div class="upload-hint">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­ Â· ì¹´ë©”ë¼ ì´¬ì˜ë„ ê°€ëŠ¥</div>
</div>

<div id="analyzingBox" class="analyzing-box hidden"><div class="spinner"></div><p>Claudeê°€ ì˜ìˆ˜ì¦ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p></div>

<div id="receiptResults" class="hidden" style="margin-top:20px">
<img id="receiptPreview" class="receipt-preview" src="" alt="">
<div id="unmatchedSection" class="hidden">
<div class="summary-card" style="border:2px solid var(--yellow)">
<h3 class="section-title">âš ï¸ ë§¤ì¹­ ì•ˆ ëœ í•­ëª©</h3>
<p style="font-size:13px;color:var(--mid);margin-bottom:12px">ì˜ìˆ˜ì¦ì—ëŠ” ìˆì§€ë§Œ ì£¼ë¬¸ ëª©ë¡ê³¼ ë§¤ì¹­ë˜ì§€ ì•Šì€ í•­ëª©ì…ë‹ˆë‹¤.</p>
<div id="unmatchedItems"></div>
</div></div>
<div id="perPersonSection" class="hidden">
<h3 class="section-title" style="margin-top:20px">ğŸ’° ì¸ë‹¹ ì •ì‚° ê¸ˆì•¡</h3>
<div id="perPersonCards"></div>
<div id="grandTotalBar" class="settle-grand-total"><span class="label">ì´ ê¸ˆì•¡</span><span class="amount" id="grandTotalAmount">â‚©0</span></div>
<button class="btn-outline" onclick="copySettlement()" style="margin-bottom:16px">ğŸ“‹ ì •ì‚° ë‚´ì—­ ë³µì‚¬</button>
<button class="btn-primary" onclick="resetSettlement()">ğŸ”„ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°</button>
</div></div>
</div>

</div></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ============================================================
//  ğŸ”¥ Firebase ì„¤ì •
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyA-i3fpf3jBsudrMmgGvup8P1EQaT9Td9s",
  authDomain: "cell-lunch-snapshot.firebaseapp.com",
  databaseURL: "https://cell-lunch-snapshot-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cell-lunch-snapshot",
  storageBucket: "cell-lunch-snapshot.firebasestorage.app",
  messagingSenderId: "924144806196",
  appId: "1:924144806196:web:427f024afd15ed6a6c1d61"
};

// Encryption
const ENCRYPT_SALT = "gachi-lunch-2025";
function encryptKey(t){let r="";for(let i=0;i<t.length;i++)r+=String.fromCharCode(t.charCodeAt(i)^ENCRYPT_SALT.charCodeAt(i%ENCRYPT_SALT.length));return btoa(unescape(encodeURIComponent(r)))}
function decryptKey(e){try{const d=decodeURIComponent(escape(atob(e)));let r="";for(let i=0;i<d.length;i++)r+=String.fromCharCode(d.charCodeAt(i)^ENCRYPT_SALT.charCodeAt(i%ENCRYPT_SALT.length));return r}catch{return""}}

// State
let firebaseReady=false,db=null,unsubscribe=null;
let currentRoom="",userName="",orders=[],isLocked=false;
let customQty=1,selectedCategory=null,editingOrderId=null,currentTab="order";
let receiptData=null,roomApiKey="";
let menuImages=[]; // {file, dataUrl, base64, mediaType}
let scannedMenus=[]; // [{name, price, description}]

const FOOD_CATEGORIES={"ğŸš í•œì‹":["ê¹€ì¹˜ì°Œê°œ","ëœì¥ì°Œê°œ","ë¹„ë¹”ë°¥","ë¶ˆê³ ê¸°","ì œìœ¡ë³¶ìŒ","ìˆœë‘ë¶€ì°Œê°œ","ê°ˆë¹„íƒ•","ëƒ‰ë©´","ì¹¼êµ­ìˆ˜","ë–¡ë³¶ì´"],"ğŸœ ì¤‘ì‹":["ì§œì¥ë©´","ì§¬ë½•","íƒ•ìˆ˜ìœ¡","ë³¶ìŒë°¥","ë§ˆíŒŒë‘ë¶€","ê¹í’ê¸°","ìœ ë¦°ê¸°","ì–‘ì¥í”¼"],"ğŸ£ ì¼ì‹":["ì´ˆë°¥","ë¼ë©˜","ìš°ë™","ì¹´ì¸ ë™","ê·œë™","ì‚¬ì‹œë¯¸","í…ë™"],"ğŸ• ì–‘ì‹":["íŒŒìŠ¤íƒ€","í”¼ì","ìŠ¤í…Œì´í¬","ë¦¬ì¡°ë˜","í–„ë²„ê±°","ìƒëŸ¬ë“œ","ìƒŒë“œìœ„ì¹˜"],"ğŸ¥¡ ë¶„ì‹":["ê¹€ë°¥","ë¼ë³¶ì´","ìˆœëŒ€","íŠ€ê¹€","ì«„ë©´","ì”ì¹˜êµ­ìˆ˜","ë§Œë‘"]};

// Init
function initFirebase(){if(!firebaseConfig.apiKey||!firebaseConfig.databaseURL)return false;try{firebase.initializeApp(firebaseConfig);db=firebase.database();firebaseReady=true;document.getElementById("setupBanner").classList.add("hidden");return true}catch(e){console.error(e);return false}}
initFirebase();
window.addEventListener("DOMContentLoaded",()=>{const p=new URLSearchParams(location.search).get("room");if(p)document.getElementById("joinInput").value=p.toUpperCase();renderCategoryPills()});

// Helpers
function notify(m,t="info"){const e=document.getElementById("notification");e.textContent=m;e.style.background=t==="error"?"var(--red)":t==="warn"?"var(--yellow)":"var(--green)";e.classList.remove("hidden");e.style.animation="none";e.offsetHeight;e.style.animation="slideDown .3s ease";clearTimeout(e._timer);e._timer=setTimeout(()=>e.classList.add("hidden"),2500)}
function genRoomId(){const c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";return Array.from({length:6},()=>c[Math.floor(Math.random()*c.length)]).join("")}
function genOrderId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}
function fmtTime(ts){return new Date(ts).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})}
function fmtMoney(n){return"â‚©"+Number(n).toLocaleString("ko-KR")}
function esc(s){const d=document.createElement("div");d.textContent=s;return d.innerHTML}

// Navigation
function showScreen(n){document.getElementById("screen-home").classList.toggle("hidden",n!=="home");document.getElementById("screen-room").classList.toggle("hidden",n!=="room")}
function goHome(){if(unsubscribe){unsubscribe();unsubscribe=null}currentRoom="";orders=[];isLocked=false;roomApiKey="";menuImages=[];scannedMenus=[];const u=new URL(location.href);u.searchParams.delete("room");history.replaceState({},"",u);showScreen("home")}
function switchTab(t){currentTab=t;document.getElementById("tabOrder").classList.toggle("active",t==="order");document.getElementById("tabSettle").classList.toggle("active",t==="settle");document.getElementById("orderTab").classList.toggle("hidden",t!=="order");document.getElementById("settleTab").classList.toggle("hidden",t!=="settle");if(t==="settle")renderKeyStatus()}

// Room
function createRoom(){const n=document.getElementById("nameInput").value.trim();if(!n){notify("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!","warn");return}if(!firebaseReady){notify("Firebase ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!","error");return}userName=n;currentRoom=genRoomId();const u=new URL(location.href);u.searchParams.set("room",currentRoom);history.replaceState({},"",u);db.ref("rooms/"+currentRoom).set({orders:{},locked:false,createdAt:Date.now(),encryptedApiKey:""});listenToRoom();showScreen("room");document.getElementById("roomCodeDisplay").textContent=currentRoom;notify("ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰")}
function joinRoom(){const n=document.getElementById("nameInput").value.trim();if(!n){notify("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!","warn");return}const c=document.getElementById("joinInput").value.trim().toUpperCase();if(!c){notify("ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!","warn");return}if(!firebaseReady){notify("Firebase ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!","error");return}userName=n;currentRoom=c;const u=new URL(location.href);u.searchParams.set("room",currentRoom);history.replaceState({},"",u);db.ref("rooms/"+currentRoom).once("value",snap=>{if(!snap.exists()){notify("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤","error");currentRoom="";return}listenToRoom();showScreen("room");document.getElementById("roomCodeDisplay").textContent=currentRoom;notify("ì…ì¥í–ˆìŠµë‹ˆë‹¤! ğŸ‘‹")})}
function listenToRoom(){if(unsubscribe)unsubscribe();const ref=db.ref("rooms/"+currentRoom);const h=ref.on("value",snap=>{const d=snap.val();if(!d)return;orders=d.orders?Object.values(d.orders):[];isLocked=d.locked||false;roomApiKey=d.encryptedApiKey?decryptKey(d.encryptedApiKey):"";renderRoom();if(currentTab==="settle")renderKeyStatus()});unsubscribe=()=>ref.off("value",h)}

// API Key
function saveApiKeyToRoom(){const k=document.getElementById("apiKeyInput").value.trim();if(!k){notify("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!","warn");return}if(!k.startsWith("sk-ant-")){notify("ì˜¬ë°”ë¥¸ Anthropic API Key í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤","warn");return}db.ref("rooms/"+currentRoom+"/encryptedApiKey").set(encryptKey(k));roomApiKey=k;document.getElementById("apiKeyInput").value="";renderKeyStatus();notify("API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”‘")}
function removeApiKeyFromRoom(){if(!confirm("API Keyë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;db.ref("rooms/"+currentRoom+"/encryptedApiKey").set("");roomApiKey="";renderKeyStatus();notify("API Keyê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")}
function renderKeyStatus(){const bar=document.getElementById("keyStatusBar");if(roomApiKey){const m=roomApiKey.slice(0,10)+"â€¢â€¢â€¢â€¢â€¢â€¢"+roomApiKey.slice(-4);bar.innerHTML=`<div class="key-status connected">âœ… API Key ì—°ê²°ë¨</div><div style="font-size:12px;color:var(--mid);margin-bottom:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap"><code style="background:var(--bg);padding:2px 8px;border-radius:6px;font-size:11px">${esc(m)}</code><button onclick="removeApiKeyFromRoom()" style="background:none;border:none;color:var(--red);font-size:12px;font-weight:600;cursor:pointer;text-decoration:underline">ì‚­ì œ</button></div>`;document.querySelector("#apiKeySection label").classList.add("hidden");document.querySelector(".api-key-row").classList.add("hidden");document.querySelector(".api-key-hint").innerHTML="ë°©ì¥ì´ ë“±ë¡í•œ API Keyë¡œ ëª¨ë“  ì°¸ì—¬ìê°€ ì •ì‚° Â· ë©”ë‰´ ìŠ¤ìº” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}else{bar.innerHTML=`<div class="key-status disconnected">âŒ API Key ë¯¸ë“±ë¡</div>`;document.querySelector("#apiKeySection label").classList.remove("hidden");document.querySelector(".api-key-row").classList.remove("hidden");document.querySelector(".api-key-hint").innerHTML="ë°©ì¥ì´ í•œ ë²ˆ ì €ì¥í•˜ë©´ ê°™ì€ ë°© ì‚¬ëŒ ëª¨ë‘ ì •ì‚°Â·ë©”ë‰´ ìŠ¤ìº” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>í‚¤ëŠ” ì•”í˜¸í™”ë˜ì–´ Firebaseì— ì €ì¥ë˜ë©°, ì´ ë°©ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤."}}

// Orders
function addOrder(m,q){if(isLocked){notify("ì£¼ë¬¸ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤!","warn");return}q=q||1;const id=genOrderId();db.ref("rooms/"+currentRoom+"/orders/"+id).set({id,user:userName,menu:m,qty:q,note:"",timestamp:Date.now()});notify(m+" ì¶”ê°€! âœ…")}
function removeOrder(id){if(isLocked)return;db.ref("rooms/"+currentRoom+"/orders/"+id).remove();notify("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ—‘ï¸")}
function saveNote(id){const i=document.getElementById("noteInput-"+id);if(!i)return;db.ref("rooms/"+currentRoom+"/orders/"+id+"/note").set(i.value);editingOrderId=null;renderRoom()}
function toggleLock(){isLocked=!isLocked;db.ref("rooms/"+currentRoom+"/locked").set(isLocked);notify(isLocked?"ì£¼ë¬¸ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”’":"ì£¼ë¬¸ì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤! ğŸ”“")}
function changeQty(d){customQty=Math.max(1,customQty+d);document.getElementById("qtyDisplay").textContent=customQty}
function addCustomOrder(){const i=document.getElementById("customItemInput"),v=i.value.trim();if(!v)return;addOrder(v,customQty);i.value="";customQty=1;document.getElementById("qtyDisplay").textContent=1}
function renderCategoryPills(){document.getElementById("catPills").innerHTML=Object.keys(FOOD_CATEGORIES).map(c=>`<button class="cat-pill${selectedCategory===c?' active':''}" onclick="selectCategory('${c}')">${c}</button>`).join("")}
function selectCategory(c){selectedCategory=selectedCategory===c?null:c;renderCategoryPills();const g=document.getElementById("menuGrid");if(selectedCategory){g.classList.remove("hidden");g.innerHTML=FOOD_CATEGORIES[selectedCategory].map(m=>`<button class="menu-btn" onclick="addOrder('${m}')">${m}</button>`).join("")}else g.classList.add("hidden")}
function copyRoomCode(){const u=location.origin+location.pathname+"?room="+currentRoom;navigator.clipboard?navigator.clipboard.writeText(u).then(()=>notify("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹")):prompt("ê³µìœ  ë§í¬:",u)}
function shareRoom(){const u=location.origin+location.pathname+"?room="+currentRoom;navigator.share?navigator.share({title:"ê°™ì´ ì‹œì¼œìš” ğŸ±",text:"ì ì‹¬ ì£¼ë¬¸ì— ì°¸ì—¬í•˜ì„¸ìš”!",url:u}):copyRoomCode()}
function copySummary(){const s=getSummary(),us=[...new Set(orders.map(o=>o.user))],tot=orders.reduce((a,o)=>a+o.qty,0);let t="ğŸ± ì ì‹¬ ì£¼ë¬¸\n"+"â”€".repeat(16)+"\n";for(const v of Object.values(s))t+=v.menu+" Ã— "+v.qty+"ê°œ\n";t+="â”€".repeat(16)+"\ní•©ê³„: "+tot+"ê°œ\nì°¸ì—¬ì: "+us.join(", ");navigator.clipboard?navigator.clipboard.writeText(t).then(()=>notify("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹")):prompt("ë³µì‚¬:",t)}
function getSummary(){return orders.reduce((a,o)=>{if(!a[o.menu])a[o.menu]={menu:o.menu,qty:0,users:[]};a[o.menu].qty+=o.qty;a[o.menu].users.push(o.user);return a},{})}

// ============================================================
//  ğŸ“¸ MENU SCAN (multi-image)
// ============================================================
function handleMenuFiles(e){addMenuFiles(Array.from(e.target.files))}
function handleMenuDrop(e){addMenuFiles(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith("image/")))}

function addMenuFiles(files){
  if(menuImages.length+files.length>10){notify("ìµœëŒ€ 10ì¥ê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤","warn");return}
  for(const file of files){
    const reader=new FileReader();
    reader.onload=ev=>{
      const dataUrl=ev.target.result;
      const base64=dataUrl.split(",")[1];
      menuImages.push({file,dataUrl,base64,mediaType:file.type||"image/jpeg"});
      renderMenuPreviews();
    };
    reader.readAsDataURL(file);
  }
}

function removeMenuImage(idx){
  menuImages.splice(idx,1);
  renderMenuPreviews();
}

function clearMenuImages(){
  menuImages=[];scannedMenus=[];
  renderMenuPreviews();
  document.getElementById("scannedMenuList").classList.add("hidden");
  document.getElementById("menuAnalyzingBox").classList.add("hidden");
  document.getElementById("menuUploadZone").classList.remove("hidden");
  const inp=document.querySelector("#menuUploadZone input[type=file]");if(inp)inp.value="";
}

function renderMenuPreviews(){
  const strip=document.getElementById("menuPreviewStrip");
  const actions=document.getElementById("menuScanActions");
  if(menuImages.length===0){
    strip.classList.add("hidden");
    actions.classList.add("hidden");
    document.getElementById("menuUploadZone").classList.remove("hidden");
    return;
  }
  strip.classList.remove("hidden");
  actions.classList.remove("hidden");
  strip.innerHTML=menuImages.map((img,i)=>`<div class="preview-thumb"><img src="${img.dataUrl}" alt=""><button class="remove-thumb" onclick="removeMenuImage(${i})">Ã—</button></div>`).join("")+`<div style="display:flex;align-items:center;font-size:12px;color:var(--mid);padding:0 8px;white-space:nowrap">${menuImages.length}/10ì¥</div>`;
}

async function scanMenuImages(){
  if(!roomApiKey){notify("API Keyê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ì‚° íƒ­ì—ì„œ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!","warn");return}
  if(menuImages.length===0){notify("ë©”ë‰´ ìŠ¤í¬ë¦°ìƒ·ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!","warn");return}

  document.getElementById("menuAnalyzingBox").classList.remove("hidden");
  document.getElementById("menuScanActions").classList.add("hidden");
  document.getElementById("scannedMenuList").classList.add("hidden");

  try{
    const content=[];
    for(const img of menuImages){
      content.push({type:"image",source:{type:"base64",media_type:img.mediaType,data:img.base64}});
    }
    content.push({type:"text",text:`ì´ ì´ë¯¸ì§€ë“¤ì€ ë°°ë‹¬ì•±(ì¿ íŒ¡ì´ì¸ , ë°°ë‹¬ì˜ë¯¼ì¡±, ìš”ê¸°ìš” ë“±)ì˜ ë©”ë‰´ í™”ë©´ ìº¡ì²˜ì…ë‹ˆë‹¤.
ëª¨ë“  ì´ë¯¸ì§€ì—ì„œ ë©”ë‰´ í•­ëª©ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”. ì¤‘ë³µëœ ë©”ë‰´ëŠ” í•˜ë‚˜ë§Œ í¬í•¨í•˜ì„¸ìš”.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”:
{
  "restaurant_name": "ê°€ê²Œì´ë¦„(ì•Œ ìˆ˜ ìˆëŠ” ê²½ìš°, ëª¨ë¥´ë©´ ë¹ˆ ë¬¸ìì—´)",
  "menus": [
    {
      "name": "ë©”ë‰´ ì´ë¦„",
      "price": ê°€ê²©(ìˆ«ì, ëª¨ë¥´ë©´ 0),
      "description": "ê°„ë‹¨í•œ ì„¤ëª…(ìˆìœ¼ë©´, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)"
    }
  ]
}

ì£¼ì˜ì‚¬í•­:
- ì˜µì…˜ì´ë‚˜ í† í•‘ì´ ì•„ë‹Œ ë©”ì¸ ë©”ë‰´ í•­ëª©ë§Œ ì¶”ì¶œ
- ê°€ê²©ì´ ì—¬ëŸ¬ ê°œì¸ ê²½ìš°(ì‚¬ì´ì¦ˆë³„ ë“±) ê¸°ë³¸ ê°€ê²© ì‚¬ìš©
- í’ˆì ˆ í‘œì‹œëœ ë©”ë‰´ëŠ” ì œì™¸`});

    const resp=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":roomApiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:4000,messages:[{role:"user",content}]})
    });

    if(!resp.ok){const err=await resp.json().catch(()=>({}));throw new Error(err.error?.message||"API ìš”ì²­ ì‹¤íŒ¨ ("+resp.status+")")}

    const data=await resp.json();
    const text=data.content.map(c=>c.text||"").join("");
    const cleaned=text.replace(/```json|```/g,"").trim();
    const parsed=JSON.parse(cleaned);

    scannedMenus=parsed.menus||[];
    const restaurantName=parsed.restaurant_name||"";

    document.getElementById("menuAnalyzingBox").classList.add("hidden");
    document.getElementById("menuScanActions").classList.remove("hidden");
    renderScannedMenus(restaurantName);
    notify(`${scannedMenus.length}ê°œ ë©”ë‰´ë¥¼ ì¸ì‹í–ˆìŠµë‹ˆë‹¤! âœ…`);

  }catch(err){
    console.error(err);
    document.getElementById("menuAnalyzingBox").classList.add("hidden");
    document.getElementById("menuScanActions").classList.remove("hidden");
    notify("ë©”ë‰´ ì¸ì‹ ì‹¤íŒ¨: "+err.message,"error");
  }
}

function renderScannedMenus(restaurantName){
  if(scannedMenus.length===0){document.getElementById("scannedMenuList").classList.add("hidden");return}
  document.getElementById("scannedMenuList").classList.remove("hidden");
  document.getElementById("scannedMenuCount").textContent=(restaurantName?restaurantName+" Â· ":"")+scannedMenus.length+"ê°œ ë©”ë‰´";

  document.getElementById("scannedMenuGrid").innerHTML=scannedMenus.map((m,i)=>{
    const priceStr=m.price?fmtMoney(m.price):"";
    const desc=m.description?`<div style="font-size:11px;color:var(--mid);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px">${esc(m.description)}</div>`:"";
    return `<div class="scanned-menu-item">
      <div style="flex:1;min-width:0">
        <div class="menu-name">${esc(m.name)}</div>
        ${desc}
      </div>
      ${priceStr?`<div class="menu-price">${priceStr}</div>`:""}
      <button class="menu-add-btn" onclick="addOrder('${esc(m.name).replace(/'/g,"\\'")}')">ë‹´ê¸°</button>
    </div>`;
  }).join("");
}

// ============================================================
//  ğŸ§¾ Receipt Analysis
// ============================================================
function handleFileSelect(e){const f=e.target.files[0];if(f)processReceiptImage(f)}
function handleFileDrop(e){const f=e.dataTransfer.files[0];if(f&&f.type.startsWith("image/"))processReceiptImage(f)}

async function processReceiptImage(file){
  if(!roomApiKey){notify("API Keyê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°©ì¥ì—ê²Œ ìš”ì²­í•˜ì„¸ìš”!","warn");return}
  if(orders.length===0){notify("ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.","warn");return}
  const reader=new FileReader();
  reader.onload=async ev=>{
    const b64Full=ev.target.result,b64=b64Full.split(",")[1],mt=file.type||"image/jpeg";
    document.getElementById("receiptResults").classList.remove("hidden");
    document.getElementById("receiptPreview").src=b64Full;
    document.getElementById("uploadZone").classList.add("hidden");
    document.getElementById("analyzingBox").classList.remove("hidden");
    document.getElementById("perPersonSection").classList.add("hidden");
    document.getElementById("unmatchedSection").classList.add("hidden");
    try{await analyzeReceipt(b64,mt)}catch(err){console.error(err);notify("ì˜ìˆ˜ì¦ ë¶„ì„ ì‹¤íŒ¨: "+err.message,"error");resetSettlement()}
  };reader.readAsDataURL(file);
}

async function analyzeReceipt(b64,mt){
  const ol=orders.map(o=>({id:o.id,user:o.user,menu:o.menu,qty:o.qty}));
  const prompt=`ì´ ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.

ì•„ë˜ëŠ” ì‚¬ëŒë“¤ì´ ì£¼ë¬¸í•œ ëª©ë¡ì…ë‹ˆë‹¤:
${JSON.stringify(ol,null,2)}

ì˜ìˆ˜ì¦ì—ì„œ ê° ë©”ë‰´ í•­ëª©ì˜ ì´ë¦„ê³¼ ê°€ê²©ì„ ì¶”ì¶œí•˜ê³ , ìœ„ ì£¼ë¬¸ ëª©ë¡ê³¼ ë§¤ì¹­í•´ì£¼ì„¸ìš”.
ë©”ë‰´ ì´ë¦„ì´ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šë”ë¼ë„ ìœ ì‚¬í•˜ë©´ ë§¤ì¹­í•´ì£¼ì„¸ìš”.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{"receipt_items":[{"name":"ì˜ìˆ˜ì¦ë©”ë‰´ëª…","price":ê°€ê²©,"quantity":ìˆ˜ëŸ‰,"matched_order_ids":["id"],"matched":true}],"total":ì´ì•¡,"delivery_fee":ë°°ë‹¬ë¹„,"extra_charges":ê¸°íƒ€}

ë§¤ì¹­ ì•ˆ ë˜ë©´ matched:false, matched_order_ids:[]. ë°°ë‹¬ë¹„/ë¶€ê°€ì„¸ ë“±ì€ delivery_fee/extra_chargesì—.`;

  const resp=await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",headers:{"Content-Type":"application/json","x-api-key":roomApiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2000,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mt,data:b64}},{type:"text",text:prompt}]}]})
  });
  if(!resp.ok){const e=await resp.json().catch(()=>({}));throw new Error(e.error?.message||"API ì‹¤íŒ¨")}
  const data=await resp.json();const text=data.content.map(c=>c.text||"").join("").replace(/```json|```/g,"").trim();
  try{receiptData=JSON.parse(text)}catch{throw new Error("íŒŒì‹± ì‹¤íŒ¨")}
  document.getElementById("analyzingBox").classList.add("hidden");
  renderSettlement();
}

function renderSettlement(){
  if(!receiptData)return;
  const items=receiptData.receipt_items||[],df=receiptData.delivery_fee||0,ec=receiptData.extra_charges||0,sc=df+ec;
  const us=[...new Set(orders.map(o=>o.user))],pps=us.length>0?Math.round(sc/us.length):0;
  const uc={};for(const u of us)uc[u]={items:[],subtotal:0};
  const unmatched=[];
  for(const item of items){
    if(item.matched&&item.matched_order_ids&&item.matched_order_ids.length>0){
      const pp=Math.round(item.price/item.matched_order_ids.length);
      for(const oid of item.matched_order_ids){const o=orders.find(x=>x.id===oid);if(o){if(!uc[o.user])uc[o.user]={items:[],subtotal:0};uc[o.user].items.push({name:item.name,price:pp});uc[o.user].subtotal+=pp}}
    }else unmatched.push(item);
  }
  let ch="",gt=0;
  for(const user of us){const c=uc[user];if(!c)continue;const tot=c.subtotal+pps;gt+=tot;const isMe=user===userName;
    ch+=`<div class="settle-user-card${isMe?' is-me':''}"><div class="settle-user-header"><div class="settle-user-name"><div class="avatar" style="background:${isMe?'var(--accent)':'var(--dark)'};width:28px;height:28px;font-size:12px">${esc(user.charAt(0))}</div>${esc(user)}${isMe?'<span class="me-tag">ë‚˜</span>':''}</div><div class="settle-user-total">${fmtMoney(tot)}</div></div>`;
    for(const it of c.items)ch+=`<div class="settle-item-row"><span>${esc(it.name)}</span><span style="font-weight:600">${fmtMoney(it.price)}</span></div>`;
    if(pps>0)ch+=`<div class="settle-item-row" style="color:var(--mid)"><span>ğŸ“¦ ë°°ë‹¬ë¹„/ì¶”ê°€ (1/${us.length})</span><span style="font-weight:600">${fmtMoney(pps)}</span></div>`;
    ch+=`</div>`;
  }
  document.getElementById("perPersonCards").innerHTML=ch;
  if(unmatched.length>0){
    document.getElementById("unmatchedSection").classList.remove("hidden");
    let uh="";for(let i=0;i<unmatched.length;i++){const it=unmatched[i];uh+=`<div class="settle-edit-row"><span style="flex:1;font-weight:600;font-size:14px">${esc(it.name)}</span><span style="font-weight:700;margin-right:8px;white-space:nowrap">${fmtMoney(it.price)}</span><select id="unmatchedAssign${i}" style="padding:8px 10px;border-radius:8px;border:1.5px solid var(--light);font-size:13px;font-family:inherit;min-width:90px"><option value="">ì‚¬ëŒ ì„ íƒ</option>${us.map(u=>`<option value="${esc(u)}">${esc(u)}</option>`).join("")}<option value="__split__">ê· ë“± ë¶„ë°°</option></select></div>`}
    uh+=`<button class="btn-primary" style="margin-top:12px" onclick="applyUnmatched()">ì ìš©í•˜ê¸°</button>`;
    document.getElementById("unmatchedItems").innerHTML=uh;
  }else document.getElementById("unmatchedSection").classList.add("hidden");
  document.getElementById("grandTotalAmount").textContent=fmtMoney(receiptData.total||gt);
  document.getElementById("perPersonSection").classList.remove("hidden");
}

function applyUnmatched(){
  if(!receiptData)return;const items=receiptData.receipt_items||[];const um=items.filter(i=>!i.matched||!i.matched_order_ids||i.matched_order_ids.length===0);const us=[...new Set(orders.map(o=>o.user))];let changed=false;
  for(let i=0;i<um.length;i++){const sel=document.getElementById("unmatchedAssign"+i);if(!sel||!sel.value)continue;changed=true;const item=um[i];
    if(sel.value==="__split__"){item.matched=true;item.matched_order_ids=us.map(u=>{const o=orders.find(x=>x.user===u);return o?o.id:null}).filter(Boolean)}
    else{const uo=orders.filter(o=>o.user===sel.value);if(uo.length>0){item.matched=true;item.matched_order_ids=[uo[0].id]}}
  }
  if(changed){renderSettlement();notify("ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…")}else notify("ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤","warn");
}

function resetSettlement(){receiptData=null;document.getElementById("receiptResults").classList.add("hidden");document.getElementById("analyzingBox").classList.add("hidden");document.getElementById("uploadZone").classList.remove("hidden");document.getElementById("perPersonSection").classList.add("hidden");document.getElementById("unmatchedSection").classList.add("hidden");const i=document.querySelector("#uploadZone input[type=file]");if(i)i.value=""}

function copySettlement(){
  if(!receiptData)return;const items=receiptData.receipt_items||[],df=receiptData.delivery_fee||0,ec=receiptData.extra_charges||0,sc=df+ec,us=[...new Set(orders.map(o=>o.user))],pps=us.length>0?Math.round(sc/us.length):0;
  const uc={};for(const u of us)uc[u]={items:[],subtotal:0};
  for(const item of items){if(item.matched&&item.matched_order_ids&&item.matched_order_ids.length>0){const pp=Math.round(item.price/item.matched_order_ids.length);for(const oid of item.matched_order_ids){const o=orders.find(x=>x.id===oid);if(o){if(!uc[o.user])uc[o.user]={items:[],subtotal:0};uc[o.user].items.push({name:item.name,price:pp});uc[o.user].subtotal+=pp}}}}
  let t="ğŸ’° ì ì‹¬ ì •ì‚°\n"+"â•".repeat(20)+"\n\n";
  for(const user of us){const c=uc[user];if(!c)continue;const tot=c.subtotal+pps;t+=`ğŸ‘¤ ${user}\n`;for(const it of c.items)t+=`  ${it.name}: ${fmtMoney(it.price)}\n`;if(pps>0)t+=`  ë°°ë‹¬ë¹„/ì¶”ê°€: ${fmtMoney(pps)}\n`;t+=`  âœ í•©ê³„: ${fmtMoney(tot)}\n\n`}
  t+="â•".repeat(20)+"\n"+`ì´ ê¸ˆì•¡: ${fmtMoney(receiptData.total||0)}`;
  navigator.clipboard?navigator.clipboard.writeText(t).then(()=>notify("ì •ì‚° ë‚´ì—­ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹")):prompt("ë³µì‚¬:",t);
}

// Render Room
function renderRoom(){
  const us=[...new Set(orders.map(o=>o.user))],tot=orders.reduce((s,o)=>s+o.qty,0),sm=getSummary();
  document.getElementById("statUsers").textContent=us.length+"ëª…";
  document.getElementById("statTotal").textContent=tot+"ê°œ";
  document.getElementById("statKinds").textContent=Object.keys(sm).length+"ê°€ì§€";
  const badge=document.getElementById("statusBadge");badge.textContent=isLocked?"ğŸ”’ ë§ˆê°":"ğŸŸ¢ ì£¼ë¬¸ì¤‘";badge.className="status-badge "+(isLocked?"status-locked":"status-open");
  const lb=document.getElementById("lockBtn");lb.textContent=isLocked?"ğŸ”“ ì£¼ë¬¸ ì—´ê¸°":"ğŸ”’ ì£¼ë¬¸ ë§ˆê°";lb.style.background=isLocked?"var(--green)":"var(--red)";
  document.getElementById("quickMenuSection").classList.toggle("hidden",isLocked);
  document.getElementById("customOrderSection").classList.toggle("hidden",isLocked);
  document.getElementById("menuScanSection").classList.toggle("hidden",isLocked);
  const c=document.getElementById("ordersContainer");
  if(orders.length===0){c.innerHTML=`<div class="empty-state"><div class="emoji">ğŸ½ï¸</div><p style="font-weight:600">ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p><p style="font-size:13px;margin-top:4px">ìœ„ì—ì„œ ë©”ë‰´ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”!</p></div>`}
  else{let h="";for(const user of us){const uo=orders.filter(o=>o.user===user),isMe=user===userName;
    h+=`<div class="user-card${isMe?' is-me':''}"><div class="user-header"><div class="avatar" style="background:${isMe?'var(--accent)':'var(--dark)'}">${user.charAt(0)}</div><span style="font-weight:700;font-size:15px">${esc(user)}</span>${isMe?'<span class="me-tag">ë‚˜</span>':''}<span style="font-size:12px;color:var(--mid);margin-left:auto">${uo.length}ê°œ</span></div>`;
    for(const o of uo){h+=`<div class="order-row"><span class="order-menu">${esc(o.menu)}</span>`;if(o.qty>1)h+=`<span class="order-qty">Ã—${o.qty}</span>`;if(o.note)h+=`<span class="order-note">ğŸ’¬ ${esc(o.note)}</span>`;h+=`<span class="order-time">${fmtTime(o.timestamp)}</span>`;if(isMe&&!isLocked)h+=`<button class="icon-btn" onclick="editingOrderId='${o.id}';renderRoom()">ğŸ“</button><button class="icon-btn" onclick="removeOrder('${o.id}')">ğŸ—‘ï¸</button>`;h+=`</div>`;if(editingOrderId===o.id)h+=`<div class="note-row"><input id="noteInput-${o.id}" class="note-input" placeholder="ìš”ì²­ì‚¬í•­" value="${esc(o.note||'')}" onkeydown="if(event.key==='Enter')saveNote('${o.id}')"><button class="note-save" onclick="saveNote('${o.id}')">ì €ì¥</button></div>`}
    h+=`</div>`}c.innerHTML=h}
  const ss=document.getElementById("summarySection");
  if(orders.length>0){ss.classList.remove("hidden");let sh="";for(const s of Object.values(sm))sh+=`<div class="summary-row"><span style="font-weight:600">${esc(s.menu)}</span><span style="color:var(--accent);font-weight:700">${s.qty}ê°œ</span></div>`;sh+=`<div class="summary-total"><span>í•©ê³„</span><span style="color:var(--accent)">${tot}ê°œ</span></div>`;document.getElementById("summaryInner").innerHTML=sh}else ss.classList.add("hidden");
  document.getElementById("syncInfo").innerHTML=`<span class="sync-dot"></span> ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ Â· ${fmtTime(Date.now())}`;
}
</script>
</body>
</html>
